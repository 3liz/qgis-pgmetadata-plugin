<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<database name="gis" schema="pgmetadata" type="PostgreSQL - 10.14 (Debian 10.14-1.pgdg100+1)">
   <sequences>
      <sequence increment="1" name="contact_id_seq" startValue="1"/>
      <sequence increment="1" name="dataset_contact_id_seq" startValue="1"/>
      <sequence increment="1" name="dataset_id_seq" startValue="1"/>
      <sequence increment="1" name="glossary_id_seq" startValue="1"/>
      <sequence increment="1" name="html_template_id_seq" startValue="1"/>
      <sequence increment="1" name="link_id_seq" startValue="1"/>
   </sequences>
   <tables>
      <table name="contact" numRows="0" remarks="List of contacts related to the published datasets." schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.contact_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="Internal automatic integer ID" size="10" type="serial" typeCode="4">
            <child column="fk_id_contact" foreignKey="dataset_contact_fk_id_contact_fkey" implied="false" onDeleteCascade="false" schema="pgmetadata" table="dataset_contact"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="Full name of the contact" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="organisation_name" nullable="false" remarks="Organisation name. E.g. ACME" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="organisation_unit" nullable="true" remarks="Organisation unit name. E.g. GIS unit" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="email" nullable="true" remarks="Email address" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="contact_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="dataset" numRows="0" remarks="Main table for storing dataset about PostgreSQL vector layers." schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.dataset_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="Internal automatic integer ID" size="10" type="serial" typeCode="4">
            <child column="fk_id_dataset" foreignKey="dataset_contact_fk_id_dataset_fkey" implied="false" onDeleteCascade="true" schema="pgmetadata" table="dataset_contact"/>
            <child column="fk_id_dataset" foreignKey="link_fk_id_dataset_fkey" implied="false" onDeleteCascade="true" schema="pgmetadata" table="link"/>
         </column>
         <column autoUpdated="false" defaultValue="uuid_generate_v4()" digits="0" id="1" name="uid" nullable="false" remarks="Unique identifier of the data. E.g. 89e3dde9-3850-c211-5045-b5b09aa1da9a" size="2147483647" type="uuid" typeCode="1111"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="table_name" nullable="false" remarks="Name of the related table in the database" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="schema_name" nullable="false" remarks="Name of the related schema in the database" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="title" nullable="false" remarks="Title of the data" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="abstract" nullable="false" remarks="Full description of the data" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="categories" nullable="true" remarks="List of categories" size="2147483647" type="_text" typeCode="2003"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="keywords" nullable="true" remarks="List of keywords" size="2147483647" type="_text" typeCode="2003"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="spatial_level" nullable="true" remarks="Spatial level of the data. E.g. city, country, street" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="9" name="minimum_optimal_scale" nullable="true" remarks="Minimum optimal scale denominator to view the data. E.g. 100000 for 1/100000. Most &quot;zoomed out&quot;." size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="10" name="maximum_optimal_scale" nullable="true" remarks="Maximum optimal scale denominator to view the data. E.g. 2000 for 1/2000. Most &quot;zoomed in&quot;." size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="now()" digits="6" id="11" name="publication_date" nullable="true" remarks="Date of publication of the data" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="12" name="publication_frequency" nullable="true" remarks="Frequency of publication: how often the data is published." size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="13" name="license" nullable="true" remarks="License. E.g. Public domain" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="14" name="confidentiality" nullable="true" remarks="Confidentiality of the data." size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="15" name="feature_count" nullable="true" remarks="Number of features of the data" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="16" name="geometry_type" nullable="true" remarks="Geometry type. E.g. Polygon" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="17" name="projection_name" nullable="true" remarks="Projection name of the dataset. E.g. WGS 84 - Geographic" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="18" name="projection_authid" nullable="true" remarks="Projection auth id. E.g. EPSG:4326" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="19" name="spatial_extent" nullable="true" remarks="Spatial extent of the data. xmin,ymin,xmax,ymax." size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="now()" digits="6" id="20" name="creation_date" nullable="false" remarks="Date of creation of the dataset item" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="now()" digits="6" id="21" name="update_date" nullable="true" remarks="Date of update of the dataset item" size="29" type="timestamp" typeCode="93"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="22" name="geom" nullable="true" remarks="Geometry defining the extent of the data. Can be any polygon." size="2147483647" type="geometry" typeCode="1111"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="dataset_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="dataset_id_idx" unique="false">
            <column ascending="true" name="id"/>
         </index>
         <index name="dataset_table_name_schema_name_key" unique="true">
            <column ascending="true" name="table_name"/>
            <column ascending="true" name="schema_name"/>
         </index>
         <index name="dataset_uid_key" unique="true">
            <column ascending="true" name="uid"/>
         </index>
      </table>
      <table name="dataset_contact" numRows="0" remarks="Pivot table between dataset and contacts." schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.dataset_contact_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="Internal automatic integer ID" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="fk_id_contact" nullable="false" remarks="Id of the contact item" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="dataset_contact_fk_id_contact_fkey" implied="false" onDeleteCascade="false" schema="pgmetadata" table="contact"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="fk_id_dataset" nullable="false" remarks="Id of the dataset item" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="dataset_contact_fk_id_dataset_fkey" implied="false" onDeleteCascade="true" schema="pgmetadata" table="dataset"/>
         </column>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="contact_role" nullable="false" remarks="Role of the contact for the specified dataset item. E.g. owner, distributor" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="dataset_contact_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="dataset_contact_fk_id_contact_fk_id_dataset_contact_role_key" unique="true">
            <column ascending="true" name="fk_id_contact"/>
            <column ascending="true" name="fk_id_dataset"/>
            <column ascending="true" name="contact_role"/>
         </index>
      </table>
      <table name="glossary" numRows="120" remarks="List of labels and words used as labels for stored data" schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.glossary_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="Internal automatic integer ID" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="field" nullable="false" remarks="Field name" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="code" nullable="false" remarks="Item code" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="label" nullable="false" remarks="Item label" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="description" nullable="true" remarks="Description" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="item_order" nullable="true" remarks="Display order" size="5" type="int2" typeCode="5"/>
         <index name="glossary_id_idx" unique="false">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="html_template" numRows="0" remarks="This table contains the HTML templates for the main metadata sheet, and one for the contacts and links. Contacts and links templates are used to compute a unique contact or link HTML representation." schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.html_template_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="section" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="content" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="html_template_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
         <index name="html_template_section_key" unique="true">
            <column ascending="true" name="section"/>
         </index>
         <checkConstraint constraint="((section = ANY (ARRAY['main'::text, 'contacts'::text, 'links'::text])))" name="html_template_section_check"/>
      </table>
      <table name="link" numRows="0" remarks="List of links related to the published datasets." schema="pgmetadata" type="TABLE">
         <column autoUpdated="true" defaultValue="nextval('pgmetadata.link_id_seq'::regclass)" digits="0" id="0" name="id" nullable="false" remarks="Internal automatic integer ID" size="10" type="serial" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="name" nullable="false" remarks="Name of the link" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="type" nullable="false" remarks="Type of the link. E.g. https, git, OGC:WFS" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="url" nullable="false" remarks="Full URL" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="4" name="description" nullable="true" remarks="Description" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="5" name="format" nullable="true" remarks="Format." size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="6" name="mime" nullable="true" remarks="Mime type" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="7" name="size" nullable="true" remarks="Size of the target" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="8" name="fk_id_dataset" nullable="false" remarks="Id of the dataset item" size="10" type="int4" typeCode="4">
            <parent column="id" foreignKey="link_fk_id_dataset_fkey" implied="false" onDeleteCascade="true" schema="pgmetadata" table="dataset"/>
         </column>
         <primaryKey column="id" sequenceNumberInPK="1"/>
         <index name="link_pkey" unique="true">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="qgis_plugin" numRows="0" remarks="Version and date of the database structure. Useful for database structure and glossary data migrations between the plugin versions by the QGIS plugin pg_metadata" schema="pgmetadata" type="TABLE">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="id" nullable="false" remarks="" size="10" type="int4" typeCode="4"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="version" nullable="false" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="version_date" nullable="false" remarks="" size="13" type="date" typeCode="91"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="3" name="status" nullable="false" remarks="" size="5" type="int2" typeCode="5"/>
         <index name="qgis_plugin_id_idx" unique="false">
            <column ascending="true" name="id"/>
         </index>
      </table>
      <table name="v_table_comment_from_metadata" numRows="0" remarks="View containing the desired formated comment for the tables listed in the pgmetadata.dataset table. This view is used by the trigger to update the table comment when the dataset item is added or modified" schema="pgmetadata" type="VIEW" viewSql=" SELECT d.schema_name AS table_schema,&#10;    d.table_name,&#10;    concat(d.title, ' - ', d.abstract, ' (', array_to_string(d.categories, ', '::text), ')') AS table_comment&#10;   FROM pgmetadata.dataset d;">
         <column autoUpdated="false" defaultValue="null" digits="0" id="0" name="table_schema" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="1" name="table_name" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
         <column autoUpdated="false" defaultValue="null" digits="0" id="2" name="table_comment" nullable="true" remarks="" size="2147483647" type="text" typeCode="12"/>
      </table>
   </tables>
   <routines>
      <routine dataAccess="MODIFIES" deterministic="false" name="get_dataset_item_html_content" returnType="text" securityType="INVOKER" type="FUNCTION">
         <comment><![CDATA[Generate the HTML content for the given table, based on the template stored in the pgmetadata.html_template table.]]></comment>
         <definition language="PLPGSQL"><![CDATA[
DECLARE
    item record;
    html text;
BEGIN

    -- Get main HTML template
    SELECT content
    FROM pgmetadata.html_template AS h
    WHERE True
    AND section = _template_section
    INTO html
    ;

    IF html IS NULL THEN
        RETURN 'No HTML template found';
    END IF;

    -- Get dataset item
    -- We transpose dataset record into rows such as
    -- col    | val
    -- id     | 1
    -- uid    | dfd3b73c-3cd3-40b7-b92d-aa0f625c86fe
    -- ...
    -- title  | My title
    -- For each row, we search and replace the [% "col" %] by val
    FOR item IN
        SELECT (line.d).key AS col, Coalesce((line.d).value, '') AS val
        FROM (
            SELECT json_each_text(row_to_json(d.*)) d
            FROM pgmetadata.dataset AS d
            WHERE True
            AND d.schema_name = _table_schema
            AND d.table_name = _table_name
        ) AS line
    LOOP
        -- replace QGIS style field [% "my_field" %] by field value
        html = regexp_replace(
            html,
            concat('\[%( )*?(")*', item.col ,'(")*( )*%\]'),
            item.val,
            'g'
        )
        ;

    END LOOP;

    RETURN html;

END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="update_postgresql_table_comment" returnType="boolean" securityType="INVOKER" type="FUNCTION">
         <comment><![CDATA[Update the PostgreSQL comment of a table by giving table schema, name and comment
Example: if you need to update the comments for all the items listed by pgmetadata.v_table_comment_from_metadata:

    SELECT
    v.table_schema,
    v.table_name,
    pgmetadata.update_postgresql_table_comment(
        v.table_schema,
        v.table_name,
        v.table_comment
    ) AS comment_updated
    FROM pgmetadata.v_table_comment_from_metadata AS v

    ]]></comment>
         <definition language="PLPGSQL"><![CDATA[
DECLARE
    sql_text text;
BEGIN

    BEGIN
        sql_text = 'COMMENT ON TABLE ' || quote_ident(table_schema) || '.' || quote_ident(table_name) || ' IS ' || quote_literal(table_comment) ;
        EXECUTE sql_text;
        RAISE NOTICE 'Comment updated for %s', quote_ident(table_schema) || '.' || quote_ident(table_name) ;
        RETURN True;
    EXCEPTION WHEN OTHERS THEN
        RAISE NOTICE 'ERROR - Failed updated comment for table %s', quote_ident(table_schema) || '.' || quote_ident(table_name);
        RETURN False;
    END;

    RETURN True;
END;
]]></definition>
      </routine>
      <routine dataAccess="MODIFIES" deterministic="false" name="update_table_comment_from_dataset" returnType="trigger" securityType="INVOKER" type="FUNCTION">
         <comment><![CDATA[Update the PostgreSQL table comment when updating or inserting a line in pgmetadata.dataset table. Comment is taken from the view pgmetadata.v_table_comment_from_metadata.]]></comment>
         <definition language="PLPGSQL"><![CDATA[
DECLARE
    is_updated bool;
BEGIN
    SELECT pgmetadata.update_postgresql_table_comment(
        v.table_schema,
        v.table_name,
        v.table_comment
    )
    FROM pgmetadata.v_table_comment_from_metadata AS v
    WHERE True
    AND v.table_schema = NEW.schema_name
    AND v.table_name = NEW.table_name
    INTO is_updated
    ;

    RETURN NEW;
END;
]]></definition>
      </routine>
   </routines>
</database>
